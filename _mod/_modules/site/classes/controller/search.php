<?php defined('SYSPATH') or die('No direct script access.');class Controller_Search extends Controller_Themes_Default {    protected $search;    protected $id1;	protected $id2;	protected $id3;	protected $id4;	    public function before() {        parent::before();		$this->search	= new Model_Search;		// Get Requested Parameters        $this->id1 = Request::$current->param('id1');        $this->id2 = Request::$current->param('id2');        $this->id3 = Request::$current->param('id3');        $this->id4 = Request::$current->param('id4');		//$this->perpage   = Lib::config('site.item_per_page'); 		$this->perpage   = 10; 				$this->lang_id	 = Lang::_lang_id(I18n::lang());    }	    public function action_index() {       $page = ($this->id1 == '') ? null : $this->id1;	   //print_r( $this->request->post() ); exit();	   $keyword = '';       if ($_POST) {			$post = new Validation($_POST);			$post->rule('search', 'regex', array(':value', '/^[A-Za-z0-9\-\s\:\@\$\+\=\_\.\(\)]++$/iD'));			$post->rule('search', 'min_length', array(':value', 1));						if ($post->check()) {				$keyword	= Kohana::sanitize($post['search']);			} else {				$keyword	= Kohana::sanitize($keyword);			}			$this->request->redirect(URL::site('search/'.$keyword));		} 		$keyword     = (strstr($this->id1,'[A-Za-z0-9\-\s\:\@\$\+\=\_\.\(\)]++') == TRUE) ? '' : $this->id1;		/* DATABASE SEARCH */		/** Multi language Search Queries **/		 		// Table Page Category			$sql1		 = "SELECT *, "						."`tbl_page_categories`.`title`, `tbl_page_categories`.`id` " 						."FROM `tbl_page_categories` "						."LEFT JOIN `tbl_page_category_content` ON `tbl_page_categories`.`id` = `tbl_page_category_content`.`category_id` "						."WHERE `tbl_page_categories`.`id` IN ("						."SELECT `category_id` FROM `tbl_page_category_content` "						."WHERE `subject` LIKE '%{$keyword}%' "						."OR `text` LIKE '%{$keyword}%' )"												."AND `tbl_page_categories`.`status` ='publish' "						."AND `tbl_page_categories`.`title` !='home' "						."GROUP BY `tbl_page_categories`.`id`;";		$db_result1  = $this->search->query($sql1);				// Table Page		$sql2		 = "SELECT *,`tbl_pages`.`id`,`tbl_pages`.`title` FROM `tbl_pages` "						."LEFT JOIN `tbl_page_content` ON `tbl_pages`.`id` = `tbl_page_content`.`page_id` "						."LEFT JOIN `tbl_page_files` ON `tbl_pages`.`id` = `tbl_page_files`.`page_id` "						."WHERE `tbl_pages`.`id` IN ( "						."SELECT `page_id` FROM `tbl_page_content` "						."WHERE `subject` LIKE '%{$keyword}%' "						."OR `synopsis` LIKE '%{$keyword}%' "						."OR `text` LIKE '%{$keyword}%' )"						."AND `tbl_page_content`.`lang_id` ='{$this->lang_id}'"						."AND `tbl_pages`.`status` ='publish' GROUP BY `tbl_pages`.`id`;";										$db_result2  = $this->search->query($sql2);		// Table Product				$sql4		= "SELECT *,`tbl_products`.`id`,`tbl_products`.`title` FROM `tbl_products` "					."LEFT JOIN `tbl_product_content` ON `tbl_products`.`id` = `tbl_product_content`.`product_id` "					."LEFT JOIN `tbl_product_files` ON `tbl_products`.`id` = `tbl_product_files`.`product_id` "					."WHERE `tbl_products`.`id` IN ("					."SELECT `product_id` FROM `tbl_product_content` "					."WHERE `subject` LIKE '%{$keyword}%' "					."OR `text` LIKE '%{$keyword}%' "						."OR `overview` LIKE '%{$keyword}%' "						."OR `features` LIKE '%{$keyword}%' "						."OR `specification` LIKE '%{$keyword}%' )"					."AND `tbl_product_content`.`lang_id` ='{$this->lang_id}'"					."AND `tbl_products`.`status` = 'publish' GROUP BY `tbl_products`.`id`;";				$db_result4  = $this->search->query($sql4);		// Table News		$sql5		 = "SELECT *, `tbl_news`.`id`,`tbl_news`.`title` FROM `tbl_news` "					  ."LEFT JOIN `tbl_news_content` ON `tbl_news`.`id` = `tbl_news_content`.`news_id` "					  ."LEFT JOIN `tbl_news_files` ON `tbl_news`.`id` = `tbl_news_files`.`news_id` "					  ."WHERE `tbl_news`.`id` IN ("					  ."SELECT `news_id` FROM `tbl_news_content` "									  ."WHERE `subject` LIKE '%{$keyword}%' "					  ."OR `synopsis` LIKE '%{$keyword}%' "					  					  ."OR `text` LIKE '%{$keyword}%' )"					  ."AND `tbl_news_content`.`lang_id` = '{$this->lang_id}'"					  ."AND `tbl_news`.`status` ='publish' GROUP BY `tbl_news`.`id`;";					  		$db_result5  = $this->search->query($sql5);		// Table Solution Category		$sql6		 = "SELECT *, `tbl_solution_categories`.`id`,`tbl_solution_categories`.`title` FROM `tbl_solution_categories` "					  ."LEFT JOIN `tbl_solution_category_content` "					  ."ON `tbl_solution_categories`.`id` = `tbl_solution_category_content`.`category_id` "					  ."LEFT JOIN `tbl_solution_category_files` "					  ."ON `tbl_solution_categories`.`id` = `tbl_solution_category_files`.`category_id` "					  ."WHERE `tbl_solution_categories`.`id` IN ("					  ."SELECT `category_id` FROM `tbl_solution_category_content` "					  ."WHERE `subject` LIKE '%{$keyword}%' "									  ."OR `subject` LIKE '%{$keyword}%' "					  ."OR `text` LIKE '%{$keyword}%' )"					  ."AND `tbl_solution_category_content`.`lang_id` = '{$this->lang_id}'"					  ."AND `tbl_solution_categories`.`status` ='publish' GROUP BY `tbl_solution_categories`.`id`;";					  		$db_result6  = $this->search->query($sql6);		// Table Solution		$sql7		 = "SELECT *, `tbl_solutions`.`id`,`tbl_solutions`.`title` FROM `tbl_solutions` "					  ."LEFT JOIN `tbl_solution_content` ON `tbl_solutions`.`id` = `tbl_solution_content`.`solution_id` "					  ."LEFT JOIN `tbl_solution_files` ON `tbl_solution_files`.`solution_id` = `tbl_solutions`.`id` "					  ."WHERE `tbl_solutions`.`id` IN ("					  ."SELECT `solution_id` FROM `tbl_solution_content` "					  ."WHERE `subject` LIKE '%{$keyword}%' "					  ."OR `synopsis` LIKE '%{$keyword}%' "					  					  ."OR `text` LIKE '%{$keyword}%' "					  ."OR `combination1` LIKE '%{$keyword}%' "					  					  ."OR `combination2` LIKE '%{$keyword}%' "					  					  ."OR `combination3` LIKE '%{$keyword}%' )"					  					  ."AND `tbl_solution_content`.`lang_id` = '{$this->lang_id}'"					  ."AND `tbl_solutions`.`status` ='publish' GROUP BY `tbl_solutions`.`id`;";		$db_result7  = $this->search->query($sql7);		// Table Testimonial 		$sql8		 = "SELECT *, `tbl_testimonials`.`id`, `tbl_testimonials`.`title` FROM `tbl_testimonials` "					  ."LEFT JOIN `tbl_testimonial_content` ON `tbl_testimonials`.`id` = `tbl_testimonial_content`.`testimonial_id` "					  ."LEFT JOIN `tbl_testimonial_files` ON `tbl_testimonial_files`.`testimonial_id` = `tbl_testimonials`.`id` "					  ."WHERE `tbl_testimonials`.`id` IN ("					  ."SELECT `testimonial_id` FROM `tbl_testimonial_content`"					  ."WHERE `subject` LIKE '%{$keyword}%' "					  ."OR `text` LIKE '%{$keyword}%' ) "					  					  ."AND `tbl_testimonial_content`.`lang_id` = '{$this->lang_id}'"					  					  ."AND `tbl_testimonials`.`status` ='publish' GROUP BY `tbl_testimonials`.`id`;";		$db_result8  = $this->search->query($sql8);		// Table Download Type		/*		$sql9		 = "SELECT *,`tbl_download_types`.`title` FROM `tbl_download_type_content` "					  ."LEFT JOIN `tbl_download_types` ON `tbl_download_types`.`id` = `tbl_download_type_content`.`type_id` "					  ."WHERE MATCH (`tbl_download_type_content`.`subject`,`tbl_download_type_content`.`text`) "					  ."AGAINST ('{$keyword}*' IN BOOLEAN MODE) "					  ."AND `tbl_download_types`.`status` ='publish' "					  					  					  ."AND `tbl_download_type_content`.`lang_id` ='{$this->lang_id}';";		$db_result9  = $this->search->query($sql9);		 * 		 */		// Table Download File		/*		$sql10		 = "SELECT * FROM `tbl_download_file_content` "				      ."LEFT JOIN `tbl_download_files` ON `tbl_download_files`.`id` = `tbl_download_file_content`.`file_id` "					  ."LEFT JOIN `tbl_download_file_files` ON `tbl_download_file_files`.`download_id` = `tbl_download_files`.`id` "					  ."WHERE MATCH (`tbl_download_file_content`.`subject`,`tbl_download_file_content`.`text`) "					  ."AGAINST ('{$keyword}*' IN BOOLEAN MODE) "					  ."AND `tbl_download_files`.`status` ='publish' "					  					  					  ."AND `tbl_download_file_content`.`lang_id` ='{$this->lang_id}';";		$db_result10  = $this->search->query($sql10);		*/				// Define temp data		$search_var = array();		$i = 0;		$url_base = URL::base();		// Table Page Category data set		foreach($db_result1 as $result1) {				$return = Lib::to_object($result1);				if(!empty($return)) {				$return->title = $return->title == 'home' ? '' : $return->title;				$search_var[$i]['url'] = $url_base . $return->title; 								$search_var[$i]['subject'] = $return->subject;				$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');					}			$i++;		}		unset($return);				// Table Page data set		$return = array();		$upload_url = Lib::config('page.upload_url');		$upload_path = Lib::config('page.upload_path');		foreach($db_result2 as $result2) {				$return = Lib::to_object($result2);				if(!empty($return)) {				$search_var[$i]['url'] = $url_base . 'company/read/' . $return->title; 				$search_var[$i]['subject'] = $return->subject;				$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');						$search_var[$i]['image'] = is_file($upload_path.$return->file_name) ? URL::site($upload_url.str_replace('.', '_crop_300x183.',$return->file_name)) : '';			}			$i++;		}		unset($return,$upload_path,$upload_url);		/*		// Table Page Category data set		$return = array();		foreach($db_result3 as $result3) {				$return = Lib::to_object($result3);				if(!empty($return)) {				$category = array();				if ($category = Model_PageCategory::instance()->load($return->id)) {					if($category->status == 'publish' && $category->name == 'company') {						$search_var[$i]['url'] = $url_base . $category->name . '/read/' . $return->name; 						$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');					}				}			}			$i++;		}		 		unset($return);				*/		// Table Product data set		$return = array();		$upload_url = Lib::config('product.upload_url');		$upload_path = Lib::config('product.upload_path');		foreach($db_result4 as $result4) {				$return = Lib::to_object($result4);				if(!empty($return)) {				$search_var[$i]['url'] = $url_base . 'products/read/' . $return->title; 				$search_var[$i]['subject'] = $return->subject;				$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');				$search_var[$i]['image'] = is_file($upload_path.$return->file_name) 						? URL::site($upload_url.str_replace('.', '_crop_169x151.',$return->file_name)) : '';			}			$i++;		}		unset($return,$upload_path,$upload_url);				// Table News data set		$return = array();		$upload_url = Lib::config('news.upload_url');		$upload_path = Lib::config('news.upload_path');		foreach($db_result5 as $result5) {				$return = Lib::to_object($result5);			if(!empty($return)) {				$search_var[$i]['url'] = $url_base . 'company/newsevent/read/' . $return->title; 				$search_var[$i]['subject'] = $return->subject;								$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');				$search_var[$i]['image'] = is_file($upload_path.$return->file_name) ? URL::site($upload_url.str_replace('.', '_crop_248x158.',$return->file_name)) : '';					}			$i++;		}		unset($return,$upload_path,$upload_url);				// Table Solution Category data set		$return = array();		foreach($db_result6 as $result6) {				$return = Lib::to_object($result6);				if(!empty($return)) {				$search_var[$i]['url'] = $url_base . 'solution-package/category/' . $return->title; 				$search_var[$i]['subject'] = $return->subject;								$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');						}			$i++;		}		unset($return);				// Table Solution data set		$return = array();		$upload_url = Lib::config('solution.upload_url');		$upload_path = Lib::config('solution.upload_path');				foreach($db_result7 as $result7) {				$return = Lib::to_object($result7);				if(!empty($return)) {				$search_var[$i]['url'] = $url_base . 'solution-package/read/' . $return->title; 				$search_var[$i]['subject'] = $return->subject;								$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');				$search_var[$i]['image'] = is_file($upload_path.$return->file_name) ? URL::site($upload_url.str_replace('.', '_crop_169x151.',$return->file_name)) : '';			}			$i++;		}		unset($return,$upload_path,$upload_url);						// Table Testimonial data set		$return = array();		$upload_url = Lib::config('testimonial.upload_url');		$upload_path = Lib::config('testimonial.upload_path');						foreach($db_result8 as $result8) {				$return = Lib::to_object($result8);				if(!empty($return)) {				$search_var[$i]['url'] = $url_base . 'company/testimonial/read/' . $return->title; 				$search_var[$i]['subject'] = $return->subject;								$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');				$search_var[$i]['image'] = is_file($upload_path.$return->file_name) ? URL::site($upload_url.$return->file_name) : '';			}			$i++;		}		unset($return,$upload_path,$upload_url);		/*				// Table Download Type data set		$return = array();		foreach($db_result9 as $result9) {				$return = Lib::to_object($result9);				if(!empty($return)) {				$search_var[$i]['url'] = $url_base . 'products/read/' . $return->title; 				$search_var[$i]['subject'] = $return->subject;				$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');						}			$i++;		}		unset($return);		*/		// Download File data set		/*		$return = array();		$upload_url = Lib::config('download.upload_url');		$upload_path = Lib::config('download.upload_path');				foreach($db_result10 as $result10) {				$return = Lib::to_object($result10);				if(!empty($return)) {				$search_var[$i]['url'] = $url_base . 'download/' . $return->title; 				$search_var[$i]['content'] = Text::limit_words(strip_tags(trim($return->text,"\x00..\x1F")), 66,'...');				$search_var[$i]['image'] = is_file($upload_path.$return->file_name) ? URL::site($upload_url.$return->file_name) : '';						}			$i++;		}		unset($return,$upload_path,$upload_url);		*/		//print_r($search_var); exit();		//print_r($i); exit();		/* DATABASE SEARCH */		 $search_data = $search_var;		/* Here We Set Our Paging */        		$html = '';		if (!empty($search_data)) {			$total_rows      = count($search_data);			$pagination = Pagination::factory(array(					'total_items' 		=> $total_rows,					'items_per_page' 	=> $this->perpage,					'view'              => 'pagination/site'				)			);			$active_page    = empty($_GET['page']) ? 1 : $_GET['page']; 			$start_arr      = ($active_page-1)*$this->perpage;			$top_limit      = $this->perpage > $total_rows ? $total_rows : $this->perpage;			$end_arr        = ($active_page*$top_limit)-1;			$config['offset'] = $pagination->offset;        			$html       .= ''; 			$html   .= '<ul class="search_ul">';			for ($index=$start_arr;$index<=$end_arr;$index++):				if (!empty($search_data[$index]['url'])):					$html .= '<li style="overflow:hidden">';						$html .= '<h4>'.$search_data[$index]['subject'].'</h4>';						$html .= '<a style="display:block" href="'.$search_data[$index]['url'].'">';						$html .= !empty($search_data[$index]['image']) ? '<img style="float:left; margin:5px 5px 0px 0px" width="100" src="'.$search_data[$index]['image'].'" alt="'.$search_data[$index]['url'].'"/>' : '';						$html .= TEXT::limit_words(ucfirst(strip_tags(@$search_data[$index]['content'])),75,'');												$html .= '</a>';					$html .= '</li>';				endif;			endfor;			$html   .= '</ul>';			$html   .= '<div class="text-center" id="paging">';			$html   .= $pagination->render('pagination/site');			$html   .= '</div>';		} else {			$html   .= '<ul class="search_ul"><li>'.I18n::get('search_empty').'</li></ul>';		}        $content_vars        = array('data_search'=>$html,                                      'cek_empty_search'=>$search_data,                                      );		$content			= View::factory('site/search_detail_page');		foreach ($content_vars as $var => $val) {			$content->$var	= $val;		}		$this->template->page_title		= ''.__('search').' - '.$keyword.' | ' . Lib::config('site.title');		$this->template->content		= $content;     }} // End Search